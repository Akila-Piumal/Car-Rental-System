<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rent</title>
    <link rel="icon" href="favIcon.png">
    <meta name="keywords" content="Car Rental,Rent,Cars">
    <meta name="description" content="Hi there! We are Easy Car Rentals. If you want a rent car please visit us..">
    <meta name="author" content="Akila Piumal">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/normalize.css">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://kit.fontawesome.com/e16bf5be25.css" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@600&display=swap" rel="stylesheet">
</head>
<body>

<nav class="navbar navbar-expand-lg bg-body-tertiary" id="navBarNew">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">
            <img src="assets/img/rent.png" alt="Logo" width="50" height="40" class="d-inline-block align-text-top">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav " id="navListInHome">
                <li class="nav-item">
                    <a class="nav-link active fw-bold" aria-current="page" href="#" style="color: #ef6d48">Cart</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link " href="home.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="cars.html">Cars</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Contact Us</a>
                </li>

            </ul>
        </div>
        <div>
            <img src="assets/img/21-avatar-lineal.gif" alt="Logo" width="40" height="40"
                 class="d-inline-block align-text-top">
        </div>
        <small class="text-white text-muted" id="userName"></small>

    </div>
</nav>

<section id="mainOfRent" class="d-flex">
    <div id="carDetailsDiv" class="d-flex flex-column align-items-center">
        <div id="imageDiv">
            <img src="assets/img/car2.jpg" alt="">
        </div>
        <div class="row container-fluid d-flex justify-content-center mt-5">
            <div class="col-4 border-end">
                <label for="vehicleBrand" class="fw-bolder">Brand</label>
                <h3 id="vehicleBrand" class="fs-5 text-muted "></h3>
            </div>
            <div class="col-4 border-end">
                <label for="vehicleType" class="fw-bolder">Type</label>
                <h3 id="vehicleType" class="fs-5 text-muted"></h3>
            </div>
            <div class="col-4 border-end">
                <label for="vehicleNum" class="fw-bolder">Reg Number</label>
                <h3 id="vehicleNum" class="fs-5 text-muted"></h3>
            </div>
            <div class="col-4 border-end mt-3">
                <label for="dailyRate" class="fw-bolder">Daily Rate</label>
                <h3 id="dailyRate" class="fs-5 text-muted"></h3>
            </div>
            <div class="col-4 border-end mt-3">
                <label for="monthlyRate" class="fw-bolder">Monthly Rate</label>
                <h3 id="monthlyRate" class="fs-5 text-muted"></h3>
            </div>
            <div class="col-6 border-end border-start d-flex flex-column align-items-center mt-3">
                <label for="priceForExtra" class="fw-bolder">Price For Extra KM</label>
                <h3 id="priceForExtra" class="fs-5 text-muted"></h3>
            </div>
        </div>


    </div>

    <div id="summaryDiv" class="d-flex flex-column align-items-center">
        <div class="row">
            <h1>Cart Summary</h1>
        </div>

        <div class="row container-fluid ">
            <div id="formDiv" class="col-6">
                <form action="#" class="row g3" id="rentDetailsForm">
                    <div class="col-12">
                        <label for="pickUpDate" class="form-label fw-bold">Pick-Up Date</label>
                        <input type="date" class="form-control" id="pickUpDate">
                    </div>

                    <div class="col-12">
                        <label for="pickUpTime" class="form-label fw-bold">Pick-Up Time</label>
                        <input type="time" class="form-control" id="pickUpTime">
                    </div>

                    <div class="col-12">
                        <label for="returnDate" class="form-label fw-bold">Return Date</label>
                        <input type="date" class="form-control" id="returnDate">
                    </div>

                    <div class="col-12 d-flex flex-column">
                        <label for="DriverOption" class="form-label fw-bold">Driver Option</label>
                        <select id="DriverOption" class="form-select">
                            <option selected></option>
                            <option>With Driver</option>
                            <option>Without Driver</option>
                        </select>
                    </div>

                    <div class="col-12">
                        <label for="LossDamageWaiver" class="form-label fw-bold">Loss Damage Waiver <small
                                class="text-muted">(upload the paid slip below)</small> </label>
                        <input type="text" class="form-control" id="LossDamageWaiver" readonly>
                    </div>

                    <div class="col-12">
                        <label class="form-label fw-bold" for="lossDamageImgInput">loss Damage Waiver Slip</label>
                        <input id="lossDamageImgInput" name="lossdamage" type="file" class="form-control">
                    </div>

                    <div class="col-12">
                        <label for="DriverChargePerDay" class="form-label fw-bold">Driver Charge Per Day</label>
                        <input type="text" class="form-control" id="DriverChargePerDay" readonly>
                    </div>

                </form>
            </div>

            <div id="totalSummaryDiv" class="col-6 d-flex flex-column justify-content-evenly align-items-center">
                <div class="d-flex flex-column align-items-center" id="summaryDivChild">
                    <div class="col-8 mt-3">
                        <label for="rentDays" class="form-label fw-bold">Rent Days</label>
                        <input type="text" class="form-control fw-bold" id="rentDays" readonly>
                    </div>

                    <div class="col-8 mt-3">
                        <label for="driverCharge" class="form-label fw-bold">Driver Charge</label>
                        <input type="text" class="form-control fw-bold" id="driverCharge" readonly value="0.00">
                    </div>

                    <div class="col-8 mt-3">
                        <label for="rentCharge" class="form-label fw-bold">Rent Charge</label>
                        <input type="text" class="form-control fw-bold" id="rentCharge" readonly>
                    </div>

                    <div class="col-8 mt-3">
                        <label for="rentTotal" class="form-label fw-bold">Rent Total</label>
                        <input type="text" class="form-control fw-bold" id="rentTotal" readonly>
                    </div>
                </div>

                <div id="bookingBtnDiv">
                    <button class="btn btn-primary border-0 fw-bolder" id="btnBookInCart">Booking Now</button>
                </div>
            </div>

        </div>

    </div>

</section>


<script src="assets/js/jquery-3.6.1.min.js"></script>
<script src="assets/js/bootstrap.min.js"></script>
<script src="https://kit.fontawesome.com/e16bf5be25.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    let baseUrl = "http://localhost:8080/Back_End_war_exploded/";

    // when the window is loaded
    window.onload = function () {
        var loggedUser = sessionStorage.getItem("user");
        let userObject = JSON.parse(loggedUser);
        $('#userName').text(userObject.name);

        let carNum = sessionStorage.getItem("carNum");

        setCarDetails();

    };

    // set car details to the text fields
    function setCarDetails() {
        let carNum = sessionStorage.getItem("carNum");

        $.ajax({
            url: baseUrl + "car?regNo=" + carNum,
            method: 'get',
            success: function (resp) {
                $('#vehicleNum').text(resp.data.regNum);
                $('#vehicleBrand').text(resp.data.brand);
                $('#vehicleType').text(resp.data.type);
                $('#dailyRate').text(resp.data.dailyRate);
                $('#monthlyRate').text(resp.data.monthlyRate);
                $('#priceForExtra').text(resp.data.priceForExtraKM);
                $('#DriverChargePerDay').val('1000.00');
                if (resp.data.type === 'Premium') {
                    $('#LossDamageWaiver').val('15000.00');
                } else if (resp.data.type === 'Luxury') {
                    $('#LossDamageWaiver').val('20000.00');
                } else if (resp.data.type === 'General') {
                    $('#LossDamageWaiver').val('10000.00');
                }
            },
            error: function (error) {

            }
        });
    }


    $('#returnDate').change(function () {
        let pickUpDate = new Date($('#pickUpDate').val());
        let returnDate = new Date($('#returnDate').val());

        function datediff(returnDate, pickUpDate) {
            return Math.round((returnDate - pickUpDate) / (1000 * 60 * 60 * 24));
        }

        $('#rentDays').val(datediff(returnDate, pickUpDate));

        if (parseInt($('#rentDays').val()) <= 30) {
            let days = parseInt($('#rentDays').val());
            let dailyRate = parseFloat($('#dailyRate').text());
            $('#rentCharge').val(parseFloat(dailyRate * days).toFixed(2));
        } else {
            let days = parseInt($('#rentDays').val());
            let inMonthsAndDays = days / 30;
            let months = parseInt(inMonthsAndDays, 10);
            let newDays = parseFloat((inMonthsAndDays - months) * 30).toFixed(0);

            let monthlyRate = parseFloat($('#monthlyRate').text());
            let dailyRate = parseFloat($('#dailyRate').text());

            let newRentCharge = (monthlyRate * months) + (dailyRate * newDays);
            $('#rentCharge').val(parseFloat(newRentCharge).toFixed(2));
        }

        setTheDriverCharge();
        calculateRentTotal();

    });

    // Change event to driver option
    $("#DriverOption").on("change", function (event) {
        setTheDriverCharge();
        calculateRentTotal();
    });

    // set Driver charge to the input field
    function setTheDriverCharge() {
        if ($("#DriverOption").val() === 'With Driver') {
            let days = $('#rentDays').val();
            $('#driverCharge').val(parseFloat(1000 * parseInt(days)).toFixed(2));
        } else if ($("#DriverOption").val() === 'Without Driver') {
            $('#driverCharge').val('0.00');
        }
    }

    function calculateRentTotal() {
        let rentCharge = parseFloat($('#rentCharge').val());
        let driverCharge = parseFloat($('#driverCharge').val());
        $('#rentTotal').val(parseFloat(rentCharge + driverCharge).toFixed(2));
    }

    // Click the booking button
    $('#btnBookInCart').click(function () {
        var loggedUser = sessionStorage.getItem("user");
        let carNum = sessionStorage.getItem("carNum");

        // upload loss Damage Waiver slip
        var data = new FormData();
        let lossDamageImgFile = $("#lossDamageImgInput")[0].files[0];
        let lossDamageImgFilename = $("#lossDamageImgInput")[0].files[0].name;
        data.append("nic", lossDamageImgFile, lossDamageImgFilename);
        data.append("licence", lossDamageImgFile, lossDamageImgFilename);
        data.append("lossDamageWaiver", lossDamageImgFile, lossDamageImgFilename);
        data.append("frontImage", lossDamageImgFile, lossDamageImgFilename);
        data.append("backImage", lossDamageImgFile, lossDamageImgFilename);
        data.append("rightImage", lossDamageImgFile, lossDamageImgFilename);
        data.append("leftImage", lossDamageImgFile, lossDamageImgFilename);

        var lossDamageWaiverImgUrl;

        $.ajax({
            url: baseUrl + "upload",
            method: 'post',
            async: false,
            contentType: false,
            processData: false,
            data: data,
            success: function (resp) {
                lossDamageWaiverImgUrl = baseUrl + resp.data.lossDamageImgPath;
                console.log(lossDamageWaiverImgUrl);
            },
            error: function (error) {
                alert(error.responseText.message);
            }
        });

        // image uploading finished===============================================================


        // Rent id
        $.ajax({
            url: baseUrl + 'rent/getLastOne',
            method: 'get',
            async: false,
            success: function (resp) {
                console.log("awaaa");
                var rentIdNew = parseInt(resp.data.rentId) + 1;
                sessionStorage.setItem("newRentId", rentIdNew);
            },
            error: function (error) {
                alert(error.responseText.message);
            }
        });

        let rentId = sessionStorage.getItem("newRentId");
        let pickUpDate = $('#pickUpDate').val();
        let pickUpTime = $('#pickUpTime').val();
        let returnDate = $('#returnDate').val();
        let status = "Pending";
        let lossDamageWaiverPrice = parseFloat($('#LossDamageWaiver').val());
        let total = parseFloat($('#rentTotal').val());
        let lossDamageImgPath = lossDamageWaiverImgUrl;
        let user = JSON.parse(loggedUser).id;
        let rentDetails = [{rentId: rentId, carId: carNum, driverId: "B1234"}];

        let ob = {
            rentId: rentId,
            pickUpDate: pickUpDate,
            pickUpTime: pickUpTime,
            returnDate: returnDate,
            status: status,
            lossDamageWaiverPrice: lossDamageWaiverPrice,
            total: total,
            lossDamageImgPath: lossDamageImgPath,
            userId: user,
            rentDetail: rentDetails
        }

        $.ajax({
            url: baseUrl + "rent",
            method: 'post',
            dataType: "json",
            data: JSON.stringify(ob),
            contentType: "application/json",
            success: function (resp) {
                alert(resp.message);
            },
            error: function (error) {
                alert(JSON.parse(error.responseText).message);
            }
        });
    });

</script>
</body>
</html>